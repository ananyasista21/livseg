from PIL import Imagefrom PIL.TiffTags import TAGS_V2import matplotlib.pyplot as pltfrom pathlib import Pathfrom natsort import natsortedimport zarrimport numpy as npfrom tqdm import tqdmImage.MAX_IMAGE_PIXELS = Nonedef readImage(filepath):    image = Image.open(filepath)    meta_data = {TAGS_V2[key].name: image.tag_v2[key]                 for key in image.tag_v2}    return image, meta_dataif __name__ == "__main__":    # Automatically read all the files    source_directory = Path(        "/Volumes/public/Feliciano_Lab/cnt_liver3/lobule1/DAPI/")    # Create a zarr file    target_directory = Path("/Volumes/funkelab/livseg/data/")    print("creating zarr datatset")    zfile = zarr.open(target_directory/"livseg_data.zarr", mode="a")    # Get the first file    print("obtaining meta data")    filenames = list(source_directory.iterdir())    image, meta = readImage(filenames[0])    shape = (len(filenames), meta["ImageWidth"], meta["ImageLength"])    dtype = np.asarray(image).dtype    dapi_data = zfile.require_dataset(        "dapi", shape=shape, chunks=(1, 128, 128), dtype=dtype)    for key, value in meta.items():        dapi_data.attrs[key] = value    print("reading/writing files")    for z, name in tqdm(enumerate(natsorted(filenames)), total=len(filenames)):        # Read the data in the file        image, _ = readImage(name)        # Save the data in the zarr dataset        dapi_data[z] = np.asarray(image).T